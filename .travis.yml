language: cpp
sudo: false
dist: trusty

cache:
  apt: true
  directories:
    - $HOME/.cache
env:
  global:
    - SPACK_ROOT: $HOME/.cache/spack
    - PATH: $PATH:$HOME/.cache/spack/bin
    
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-4.9
      - gfortran-4.9
      - libblas-dev
      - liblapack-dev
      - libopenmpi-dev
      - libhdf5-serial-dev
      - pkg-config
      - cmake
      - libncurses5-dev
      - environment-modules

install:
  - if ! which spack >/dev/null; then mkdir -p $SPACK_ROOT && git clone --depth 50 https://github.com/spack/spack.git $SPACK_ROOT && echo -e "config:""\n  build_jobs:"" 2" > $SPACK_ROOT/etc/spack/config.yaml; fi
  - spack install googletest
  - source /etc/profile &&
    source $SPACK_ROOT/share/spack/setup-env.sh
  - spack load googletest
      
jobs:
  include:
    - stage: autotools
      script:
        - ./autogen.sh
    - stage: configure
      script:
        - ./autogen.sh
        - ./configure --with-CXX=/usr/bin/mpic++ --with-hdf5=/usr/bin/h5cc --with-lapack='-lopenblas' --with-gtest=$( spack find -p googletest | tail -1 | awk '{print $2}' )
    - stage: build
      script:
        - ./autogen.sh
        - ./configure --with-CXX=/usr/bin/mpic++ --with-hdf5=/usr/bin/h5cc --with-lapack='-lopenblas' --with-gtest=$( spack find -p googletest | tail -1 | awk '{print $2}' )
        - make -j
    - stage: test
      script:
        - ./autogen.sh
        - ./configure --with-CXX=/usr/bin/mpic++ --with-hdf5=/usr/bin/h5cc --with-lapack='-lopenblas' --with-gtest=$( spack find -p googletest | tail -1 | awk '{print $2}' )
        - make -j
        - ./tests/test_Vector
    -
      script:
        - ./autogen.sh
        - ./configure --with-CXX=/usr/bin/mpic++ --with-hdf5=/usr/bin/h5cc --with-lapack='-lopenblas' --with-gtest=$( spack find -p googletest | tail -1 | awk '{print $2}' )
        - make -j
        - ./tests/test_Matrix
    -
      script:
        - ./autogen.sh
        - ./configure --with-CXX=/usr/bin/mpic++ --with-hdf5=/usr/bin/h5cc --with-lapack='-lopenblas' --with-gtest=$( spack find -p googletest | tail -1 | awk '{print $2}' )
        - make -j
        - ./tests/test_SVD
    -
      script:
        - ./autogen.sh
        - ./configure --with-CXX=/usr/bin/mpic++ --with-hdf5=/usr/bin/h5cc --with-lapack='-lopenblas' --with-gtest=$( spack find -p googletest | tail -1 | awk '{print $2}' )
        - make -j
        - ./tests/test_IncrementalSVD


before_script:
  - export FC=gfortran-4.9
  - export F77=gfortran-4.9
  
