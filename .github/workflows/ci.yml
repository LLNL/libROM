name: Continuous Integration
on: [push]
jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Install Linux dependencies
        run: |
            sudo apt-get install libmpich-dev libblas-dev liblapack-dev libscalapack-mpi-dev libhdf5-serial-dev
      - name: Check out libROM
        uses: actions/checkout@v2
      - run: |
            DEPS_DIR="${GITHUB_WORKSPACE}/deps"
            mkdir ${DEPS_DIR} && cd ${DEPS_DIR}
            git clone https://github.com/google/googletest
            cd googletest && mkdir build && cd build
            cmake .. && make && sudo make install
            PATH=${DEPS_DIR}/googletest:${DEPS_DIR}/googletest/build:$PATH
      - name: Build libROM
        run: |
            cd ${GITHUB_WORKSPACE}/build
            export CC=mpicc
            export CXX=mpicxx
            cmake -DCMAKE_BUILD_TYPE=Debug ..
            make
            cmake -DCMAKE_BUILD_TYPE=Optimized ..
            make
      - name: Run tests
        run: |
            cd ${GITHUB_WORKSPACE}/build
            ./test_SVD
            ./test_Vector
            ./test_Matrix
            ./test_DEIM
            ./test_GNAT
            ./test_QDEIM
            ./test_IncrementalSVD
            ./test_RandomizedSVD
            mpirun -n 3 --oversubscribe test_RandomizedSVD
  mac:
    runs-on: macos-latest
    steps:
      - name: Install Mac dependencies
        run: |
            brew install gfortran
            brew install open-mpi
            brew install openblas
            brew install lapack
            brew install scalapack
            brew install hdf5
            brew install cmake
      - name: Check out libROM
        uses: actions/checkout@v2
      - run: |
            DEPS_DIR="${GITHUB_WORKSPACE}/deps"
            mkdir ${DEPS_DIR} && cd ${DEPS_DIR}
            git clone https://github.com/google/googletest
            cd googletest && mkdir build && cd build
            cmake .. && make && sudo make install
            PATH=${DEPS_DIR}/googletest:${DEPS_DIR}/googletest/build:$PATH
      - name: Build libROM
        run: |
            cd ${GITHUB_WORKSPACE}/build
            cmake -DCMAKE_BUILD_TYPE=Debug ..
            make
            cmake -DCMAKE_BUILD_TYPE=Optimized ..
            make
      - name: Run tests
        run: |
            cd ${GITHUB_WORKSPACE}/build
            ./test_SVD
            ./test_Vector
            ./test_Matrix
            ./test_DEIM
            ./test_GNAT
            ./test_QDEIM
            ./test_IncrementalSVD
            ./test_RandomizedSVD
            mpirun -n 3 --oversubscribe test_RandomizedSVD
